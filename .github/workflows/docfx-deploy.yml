name: Rebuild DocFX

on:
  push:
    branches:
      - 'docfx'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy-docfx:
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Clone source repository for documentation build
        run: |
          git clone -b master https://github.com/ZachHembree/RichHudFramework.Client.git _src

      - name: Cache DocFX and SE Reference Assemblies
        id: cache-all
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.dotnet\tools
            resources
          key: |
            deploy-res-combined-${{ hashFiles('docfx.json') }}-${{ secrets.SE_REFS_CACHE_VERSION }}
          restore-keys: deploy-res-combined-

      - name: Download SE reference assemblies if cache miss
        if: steps.cache-all.outputs.cache-hit != 'true'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: upload-se-references.yml
          branch: ${{ github.ref_name }}Â 
          name: se-reference-assemblies
          path: resources
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET 8.x
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Install DocFX 2.78.4
        if: steps.cache-all.outputs.cache-hit != 'true'
        run: |
          dotnet tool install --global docfx --version 2.78.4
        
      - name: Add DocFX to PATH
        run: |
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -Append -FilePath $env:GITHUB_PATH

      - name: Generate Releases page
        run: |
          powershell.exe -NoProfile -ExecutionPolicy Bypass -File ".\Get-Releases.ps1" -Owner "ZachHembree" -RepoName "RichHudFramework.Client"

      - name: Configure Git Safe Directory and Isolation
        run: |
          Add-Content -Path .gitignore -Value "`n_src/"

          $workspace = $env:GITHUB_WORKSPACE.Replace('\', '/')
          $srcPath = "$workspace/_src"

          git config --global --add safe.directory $srcPath
          
          Write-Host "Verifying Git status inside _src..."
          cd _src
          git status

      - name: Build documentation with DocFX
        run: docfx docfx.json

      - name: Copy Google verification file
        run: Copy-Item googlefe53ea247c41569b.html _site\

      - name: Deploy to docfx-gh-pages branch
        run: |
          cd _site

          git config --global core.autocrlf true
          git init
          git checkout --orphan docfx-gh-pages

          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

          git add --all
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "DocFX documentation build from ${{ github.sha }}"

          git push --force origin docfx-gh-pages

      - name: Documentation deployed successfully
        run: Write-Host "Documentation successfully deployed to https://zachhembree.github.io/RichHudFramework.Client/"